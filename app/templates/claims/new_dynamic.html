{% extends "base.html" %}

{% block title %}مطالبة جديدة - نظام إدارة مطالبات التأمين{% endblock %}

{% block extra_css %}
<style>
    .claim-type-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .claim-type-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .claim-type-card.selected {
        border-color: var(--bs-primary);
        background-color: rgba(var(--bs-primary-rgb), 0.1);
    }
    
    .claim-type-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .dynamic-field {
        transition: all 0.3s ease;
    }
    
    .dynamic-field.d-none {
        opacity: 0;
        transform: translateY(-10px);
    }
    
    .form-step {
        display: none;
    }
    
    .form-step.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        font-weight: bold;
        position: relative;
    }
    
    .step.active {
        background-color: var(--bs-primary);
        color: white;
    }
    
    .step.completed {
        background-color: var(--bs-success);
        color: white;
    }
    
    .step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 100%;
        width: 20px;
        height: 2px;
        background-color: #e9ecef;
        transform: translateY(-50%);
    }
    
    .step.completed:not(:last-child)::after {
        background-color: var(--bs-success);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-plus me-2"></i>
                إنشاء مطالبة جديدة - نموذج ديناميكي
            </h1>
        </div>
    </div>
    
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step-1">1</div>
        <div class="step" id="step-2">2</div>
        <div class="step" id="step-3">3</div>
    </div>
    
    <form method="POST" enctype="multipart/form-data" id="dynamic-claim-form">
        {{ form.hidden_tag() }}
        
        <!-- Step 1: Claim Type Selection -->
        <div class="form-step active" id="step-1-content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>
                                اختر نوع المطالبة
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="claim-types-container">
                                <!-- Claim types will be loaded here -->
                                <div class="col-12 text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                    <p class="mt-2 text-muted">جاري تحميل أنواع المطالبات...</p>
                                </div>
                            </div>
                            
                            <!-- Hidden field for claim type -->
                            {{ form.claim_type_id(style="display: none;") }}
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary" id="next-to-step-2" disabled>
                                    التالي
                                    <i class="fas fa-arrow-left ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Basic Information -->
        <div class="form-step" id="step-2-content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-user me-2"></i>
                                البيانات الأساسية
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Company Selection -->
                                <div class="col-md-6 mb-3">
                                    {{ form.company_id.label(class="form-label") }}
                                    {{ form.company_id(class="form-select") }}
                                    {% if form.company_id.errors %}
                                        <div class="text-danger">
                                            {% for error in form.company_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Client Name -->
                                <div class="col-md-6 mb-3">
                                    {{ form.client_name.label(class="form-label") }}
                                    {{ form.client_name(class="form-control") }}
                                    {% if form.client_name.errors %}
                                        <div class="text-danger">
                                            {% for error in form.client_name.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <!-- National ID -->
                                <div class="col-md-6 mb-3">
                                    {{ form.client_national_id.label(class="form-label") }}
                                    {{ form.client_national_id(class="form-control") }}
                                    {% if form.client_national_id.errors %}
                                        <div class="text-danger">
                                            {% for error in form.client_national_id.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Policy Number -->
                                <div class="col-md-6 mb-3">
                                    {{ form.policy_number.label(class="form-label") }}
                                    {{ form.policy_number(class="form-control") }}
                                    {% if form.policy_number.errors %}
                                        <div class="text-danger">
                                            {% for error in form.policy_number.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <!-- Incident Date -->
                                <div class="col-md-6 mb-3">
                                    {{ form.incident_date.label(class="form-label") }}
                                    {{ form.incident_date(class="form-control") }}
                                    {% if form.incident_date.errors %}
                                        <div class="text-danger">
                                            {% for error in form.incident_date.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Claim Amount -->
                                <div class="col-md-6 mb-3">
                                    {{ form.claim_amount.label(class="form-label") }}
                                    <div class="input-group">
                                        {{ form.claim_amount(class="form-control") }}
                                        <span class="input-group-text">ريال سعودي</span>
                                    </div>
                                    {% if form.claim_amount.errors %}
                                        <div class="text-danger">
                                            {% for error in form.claim_amount.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Claim Details -->
                            <div class="mb-3">
                                {{ form.claim_details.label(class="form-label") }}
                                {{ form.claim_details(class="form-control", rows="4") }}
                                {% if form.claim_details.errors %}
                                    <div class="text-danger">
                                        {% for error in form.claim_details.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" id="back-to-step-1">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    السابق
                                </button>
                                <button type="button" class="btn btn-primary" id="next-to-step-3">
                                    التالي
                                    <i class="fas fa-arrow-left ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Dynamic Fields & Files -->
        <div class="form-step" id="step-3-content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                تفاصيل إضافية ومرفقات
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Dynamic Fields Container -->
                            <div class="row" id="dynamic-fields-container">
                                <!-- Dynamic fields will be loaded here -->
                            </div>
                            
                            <!-- File Upload -->
                            <div class="row">
                                <div class="col-12 mb-3">
                                    {{ form.files.label(class="form-label") }}
                                    <div class="file-upload-area border rounded p-4 text-center">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">اسحب وأفلت الملفات هنا أو انقر لتحديد الملفات</p>
                                        {{ form.files(class="form-control", id="files", multiple=True) }}
                                    </div>
                                    {% if form.files.errors %}
                                        <div class="text-danger">
                                            {% for error in form.files.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        الملفات المسموحة: PDF, JPG, PNG, DOCX (حد أقصى 25 ميجابايت لكل ملف)
                                    </small>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" id="back-to-step-2">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    السابق
                                </button>
                                <div>
                                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary me-2">
                                        <i class="fas fa-times me-2"></i>
                                        إلغاء
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>
                                        حفظ المطالبة
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dynamic-forms.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load claim types
    loadClaimTypes();
    
    // Step navigation
    setupStepNavigation();
    
    // File upload preview
    setupFileUpload();
});

async function loadClaimTypes() {
    try {
        const response = await fetch('/api/claim-types');
        const data = await response.json();
        
        if (data.success) {
            renderClaimTypes(data.claim_types);
        } else {
            showError('فشل في تحميل أنواع المطالبات');
        }
    } catch (error) {
        console.error('Error loading claim types:', error);
        showError('حدث خطأ في تحميل أنواع المطالبات');
    }
}

function renderClaimTypes(claimTypes) {
    const container = document.getElementById('claim-types-container');
    container.innerHTML = '';
    
    claimTypes.forEach(claimType => {
        const col = document.createElement('div');
        col.className = 'col-md-4 col-lg-3 mb-3';
        
        col.innerHTML = `
            <div class="card claim-type-card h-100" data-claim-type-id="${claimType.id}">
                <div class="card-body text-center">
                    <div class="claim-type-icon" style="color: ${claimType.color}">
                        <i class="${claimType.icon}"></i>
                    </div>
                    <h6 class="card-title">${claimType.name_ar}</h6>
                    <p class="card-text text-muted small">${claimType.description_ar || ''}</p>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
    
    // Add click handlers
    document.querySelectorAll('.claim-type-card').forEach(card => {
        card.addEventListener('click', function() {
            selectClaimType(this.dataset.claimTypeId);
        });
    });
}

function selectClaimType(claimTypeId) {
    // Update UI
    document.querySelectorAll('.claim-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-claim-type-id="${claimTypeId}"]`).classList.add('selected');
    
    // Update form field
    document.getElementById('claim_type_id').value = claimTypeId;
    
    // Enable next button
    document.getElementById('next-to-step-2').disabled = false;
    
    // Load dynamic fields for step 3
    if (window.dynamicFormManager) {
        window.dynamicFormManager.loadDynamicForm(claimTypeId);
    }
}

function setupStepNavigation() {
    // Next to step 2
    document.getElementById('next-to-step-2').addEventListener('click', function() {
        if (document.getElementById('claim_type_id').value) {
            showStep(2);
        }
    });
    
    // Back to step 1
    document.getElementById('back-to-step-1').addEventListener('click', function() {
        showStep(1);
    });
    
    // Next to step 3
    document.getElementById('next-to-step-3').addEventListener('click', function() {
        if (validateStep2()) {
            showStep(3);
        }
    });
    
    // Back to step 2
    document.getElementById('back-to-step-2').addEventListener('click', function() {
        showStep(2);
    });
}

function showStep(stepNumber) {
    // Hide all steps
    document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Show target step
    document.getElementById(`step-${stepNumber}-content`).classList.add('active');
    
    // Update step indicators
    document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < stepNumber) {
            step.classList.add('completed');
        } else if (index + 1 === stepNumber) {
            step.classList.add('active');
        }
    });
}

function validateStep2() {
    const requiredFields = ['company_id', 'client_name', 'client_national_id', 'incident_date', 'claim_amount', 'claim_details'];
    let isValid = true;
    
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field && !field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else if (field) {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        alert('يرجى تعبئة جميع الحقول المطلوبة');
    }
    
    return isValid;
}

function setupFileUpload() {
    const fileInput = document.getElementById('files');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const fileList = document.createElement('div');
            fileList.className = 'mt-3';
            
            for (let i = 0; i < e.target.files.length; i++) {
                const file = e.target.files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'alert alert-info d-flex align-items-center';
                fileItem.innerHTML = `
                    <i class="fas fa-file me-2"></i>
                    <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                `;
                fileList.appendChild(fileItem);
            }
            
            // Remove previous file list
            const existingList = document.querySelector('.file-list');
            if (existingList) {
                existingList.remove();
            }
            
            // Add new file list
            fileList.className += ' file-list';
            document.querySelector('.file-upload-area').appendChild(fileList);
        });
    }
}

function showError(message) {
    const container = document.getElementById('claim-types-container');
    if (container) {
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            </div>
        `;
    }
}
</script>
{% endblock %}