{% extends "base.html" %}

{% block title %}تفاصيل المدفوعة - نظام إدارة مطالبات التأمين{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    تفاصيل المدفوعة
                </h1>
                <div>
                    <a href="{{ url_for('payments.edit_payment', payment_id=payment.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>تعديل
                    </a>
                    <a href="{{ url_for('payments.index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>العودة
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Payment Details -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        معلومات المدفوعة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>رقم المدفوعة:</strong></td>
                                    <td>{{ payment.id }}</td>
                                </tr>
                                <tr>
                                    <td><strong>رقم المطالبة:</strong></td>
                                    <td>
                                        <a href="{{ url_for('claims.view', id=payment.claim_id) }}" class="text-decoration-none">
                                            {{ payment.claim_id }}
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>المبلغ:</strong></td>
                                    <td><span class="h5 text-success">{{ payment.amount }} {{ payment.currency }}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>طريقة الدفع:</strong></td>
                                    <td>{{ payment.get_payment_method_text_ar() }}</td>
                                </tr>
                                <tr>
                                    <td><strong>الحالة:</strong></td>
                                    <td>
                                        <span class="badge bg-{{ payment.get_status_color() }} fs-6">
                                            {{ payment.get_status_text_ar() }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>تاريخ الدفع:</strong></td>
                                    <td>{{ payment.payment_date.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% if payment.received_date %}
                                <tr>
                                    <td><strong>تاريخ الاستلام:</strong></td>
                                    <td>{{ payment.received_date.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td><strong>رقم المرجع:</strong></td>
                                    <td>{{ payment.payment_reference or '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>أنشأها:</strong></td>
                                    <td>{{ payment.created_by.full_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>تاريخ الإنشاء:</strong></td>
                                    <td>{{ payment.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Method Specific Details -->
            {% if payment.payment_method == 'bank_transfer' and (payment.bank_name or payment.account_number or payment.iban) %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-university me-2"></i>
                        تفاصيل التحويل البنكي
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            {% if payment.bank_name %}
                            <p><strong>اسم البنك:</strong> {{ payment.bank_name }}</p>
                            {% endif %}
                            {% if payment.account_number %}
                            <p><strong>رقم الحساب:</strong> {{ payment.account_number }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if payment.iban %}
                            <p><strong>رقم الآيبان:</strong> {{ payment.iban }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if payment.payment_method == 'check' and (payment.check_number or payment.check_bank) %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-money-check me-2"></i>
                        تفاصيل الشيك
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            {% if payment.check_number %}
                            <p><strong>رقم الشيك:</strong> {{ payment.check_number }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if payment.check_bank %}
                            <p><strong>بنك الشيك:</strong> {{ payment.check_bank }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if payment.payment_method == 'online' and payment.transaction_id %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-credit-card me-2"></i>
                        تفاصيل الدفع الإلكتروني
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>رقم المعاملة:</strong> {{ payment.transaction_id }}</p>
                </div>
            </div>
            {% endif %}
            
            {% if payment.notes %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sticky-note me-2"></i>
                        ملاحظات
                    </h5>
                </div>
                <div class="card-body">
                    <p>{{ payment.notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Related Claim Info -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        معلومات المطالبة المرتبطة
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless table-sm">
                        <tr>
                            <td><strong>العميل:</strong></td>
                            <td>{{ payment.claim.client_name }}</td>
                        </tr>
                        <tr>
                            <td><strong>شركة التأمين:</strong></td>
                            <td>{{ payment.claim.insurance_company.name_ar }}</td>
                        </tr>
                        <tr>
                            <td><strong>مبلغ المطالبة:</strong></td>
                            <td>{{ payment.claim.claim_amount }} {{ payment.claim.currency }}</td>
                        </tr>
                        <tr>
                            <td><strong>حالة المطالبة:</strong></td>
                            <td>
                                <span class="badge bg-{{ payment.claim.get_status_color() }}">
                                    {{ payment.claim.get_status_text_ar() }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>تاريخ الحادث:</strong></td>
                            <td>{{ payment.claim.incident_date.strftime('%Y-%m-%d') if payment.claim.incident_date else '-' }}</td>
                        </tr>
                    </table>
                    <div class="mt-3">
                        <a href="{{ url_for('claims.view', id=payment.claim_id) }}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-eye me-2"></i>عرض المطالبة
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        إجراءات سريعة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('payments.edit_payment', payment_id=payment.id) }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-edit me-2"></i>تعديل المدفوعة
                        </a>
                        {% if payment.status == 'pending' %}
                        <button type="button" class="btn btn-success btn-sm" onclick="markAsReceived()">
                            <i class="fas fa-check me-2"></i>تأكيد الاستلام
                        </button>
                        {% endif %}
                        <form method="POST" action="{{ url_for('payments.delete_payment', payment_id=payment.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm w-100" 
                                    onclick="return confirm('هل أنت متأكد من حذف هذه المدفوعة؟')">
                                <i class="fas fa-trash me-2"></i>حذف المدفوعة
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function markAsReceived() {
    if (confirm('هل أنت متأكد من تأكيد استلام هذه المدفوعة؟')) {
        // Create a form to update payment status
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("payments.edit_payment", payment_id=payment.id) }}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        // Add status field
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = 'received';
        form.appendChild(statusInput);
        
        // Add received_date field
        const dateInput = document.createElement('input');
        dateInput.type = 'hidden';
        dateInput.name = 'received_date';
        dateInput.value = new Date().toISOString().split('T')[0];
        form.appendChild(dateInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
