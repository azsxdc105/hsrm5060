{% extends "base.html" %}

{% block title %}اختبار الواتساب{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fab fa-whatsapp me-2"></i>
                        اختبار إرسال الواتساب
                    </h4>
                </div>
                <div class="card-body">
                    
                    <!-- WhatsApp Status -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">حالة الواتساب</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>الإعدادات:</strong>
                                        {% if config.WHATSAPP_ACCESS_TOKEN %}
                                            <span class="badge bg-success">WhatsApp Business API مكون</span>
                                        {% elif config.SIMPLE_WHATSAPP_ENABLED %}
                                            <span class="badge bg-warning">الإعداد البسيط مفعل</span>
                                        {% else %}
                                            <span class="badge bg-danger">غير مكون</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if config.SIMPLE_WHATSAPP_NUMBER %}
                                    <div class="mb-2">
                                        <strong>الرقم المكون:</strong>
                                        <code>{{ config.SIMPLE_WHATSAPP_NUMBER }}</code>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mb-2">
                                        <strong>رقم الواتساب الخاص بك:</strong>
                                        {% if current_user.whatsapp_number %}
                                            <code>{{ current_user.whatsapp_number }}</code>
                                        {% else %}
                                            <span class="text-muted">غير محدد</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">معلومات مهمة</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-info-circle text-info me-2"></i>الإعداد البسيط يفتح واتساب ويب</li>
                                        <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>للاستخدام المهني، استخدم WhatsApp Business API</li>
                                        <li><i class="fas fa-mobile-alt text-success me-2"></i>تأكد من تشغيل واتساب على هاتفك</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test Form -->
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">إرسال رسالة تجريبية</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('advanced_notifications.whatsapp_test') }}">
                                        {{ form.hidden_tag() }}
                                        
                                        <div class="mb-3">
                                            {{ form.phone_number.label(class="form-label") }}
                                            {{ form.phone_number(class="form-control", placeholder="+966501234567") }}
                                            {% if form.phone_number.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.phone_number.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                أدخل رقم الواتساب مع رمز البلد (مثال: +966501234567)
                                            </small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            {{ form.message.label(class="form-label") }}
                                            {{ form.message(class="form-control", rows="4") }}
                                            {% if form.message.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.message.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                {{ form.use_business_api(class="form-check-input") }}
                                                {{ form.use_business_api.label(class="form-check-label") }}
                                            </div>
                                            <small class="form-text text-muted">
                                                إذا لم يكن مفعلاً، سيتم استخدام واتساب ويب
                                            </small>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            {{ form.submit(class="btn btn-success btn-lg") }}
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-secondary">
                                <div class="card-header">
                                    <h6 class="mb-0">إجراءات سريعة</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <a href="{{ url_for('admin.edit_user', user_id=current_user.id) }}" class="btn btn-outline-primary w-100">
                                                <i class="fas fa-user-edit me-2"></i>
                                                تحديث رقم الواتساب
                                            </a>
                                        </div>
                                        <div class="col-md-4">
                                            <a href="{{ url_for('advanced_notifications.settings') }}" class="btn btn-outline-info w-100">
                                                <i class="fas fa-cog me-2"></i>
                                                إعدادات الإشعارات
                                            </a>
                                        </div>
                                        <div class="col-md-4">
                                            <a href="{{ url_for('advanced_notifications.send_notification') }}" class="btn btn-outline-success w-100">
                                                <i class="fas fa-paper-plane me-2"></i>
                                                إرسال إشعار متقدم
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test Results -->
                    {% if test_result %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-{% if test_result.success %}success{% else %}danger{% endif %}">
                                <div class="card-header bg-{% if test_result.success %}success{% else %}danger{% endif %} text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-{% if test_result.success %}check-circle{% else %}exclamation-circle{% endif %} me-2"></i>
                                        نتيجة الاختبار
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if test_result.success %}
                                        <div class="alert alert-success">
                                            <h6>✅ تم الإرسال بنجاح!</h6>
                                            <p class="mb-0">{{ test_result.message }}</p>
                                            {% if test_result.whatsapp_url %}
                                                <hr>
                                                <p class="mb-2"><strong>رابط واتساب ويب:</strong></p>
                                                <a href="{{ test_result.whatsapp_url }}" target="_blank" class="btn btn-success">
                                                    <i class="fab fa-whatsapp me-2"></i>
                                                    فتح في واتساب
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-danger">
                                            <h6>❌ فشل الإرسال</h6>
                                            <p class="mb-0">{{ test_result.error }}</p>
                                        </div>
                                    {% endif %}
                                    
                                    {% if test_result.details %}
                                    <details class="mt-3">
                                        <summary class="btn btn-outline-secondary btn-sm">عرض التفاصيل</summary>
                                        <pre class="mt-2 p-2 bg-light border rounded"><code>{{ test_result.details | tojson(indent=2) }}</code></pre>
                                    </details>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.badge {
    font-size: 0.75em;
}

code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

.btn-outline-primary:hover,
.btn-outline-info:hover,
.btn-outline-success:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}

.list-unstyled li {
    margin-bottom: 0.5rem;
}

pre {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}
