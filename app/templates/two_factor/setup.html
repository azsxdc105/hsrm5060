{% extends "base.html" %}

{% block title %}إعداد المصادقة الثنائية{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        إعداد المصادقة الثنائية (2FA)
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>المصادقة الثنائية</strong> تضيف طبقة حماية إضافية لحسابك. ستحتاج إلى تطبيق مصادقة مثل Google Authenticator أو Authy.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>الخطوة 1: امسح رمز QR</h5>
                            <p class="text-muted">استخدم تطبيق المصادقة لمسح الرمز التالي:</p>
                            
                            {% if qr_code %}
                                <div class="text-center mb-3">
                                    <img src="{{ qr_code }}" alt="QR Code" class="img-fluid" style="max-width: 200px;">
                                </div>
                            {% endif %}
                            
                            <div class="alert alert-secondary">
                                <small>
                                    <strong>أو أدخل هذا الرمز يدوياً:</strong><br>
                                    <code>{{ secret }}</code>
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>الخطوة 2: أدخل رمز التحقق</h5>
                            <p class="text-muted">أدخل الرمز المكون من 6 أرقام من تطبيق المصادقة:</p>
                            
                            <form id="setup2faForm">
                                <div class="mb-3">
                                    <label for="token" class="form-label">رمز التحقق</label>
                                    <input type="text" class="form-control text-center" id="token" name="token" 
                                           maxlength="6" pattern="[0-9]{6}" required
                                           style="font-size: 1.5rem; letter-spacing: 0.5rem;">
                                    <div class="form-text">أدخل الرمز المكون من 6 أرقام</div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-check me-2"></i>
                                        تفعيل المصادقة الثنائية
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5>تطبيقات المصادقة الموصى بها:</h5>
                            <div class="row">
                                <div class="col-md-4 text-center mb-3">
                                    <i class="fab fa-google fa-2x text-primary mb-2"></i>
                                    <h6>Google Authenticator</h6>
                                    <small class="text-muted">متوفر لـ iOS و Android</small>
                                </div>
                                <div class="col-md-4 text-center mb-3">
                                    <i class="fas fa-mobile-alt fa-2x text-success mb-2"></i>
                                    <h6>Authy</h6>
                                    <small class="text-muted">متوفر لجميع المنصات</small>
                                </div>
                                <div class="col-md-4 text-center mb-3">
                                    <i class="fas fa-key fa-2x text-warning mb-2"></i>
                                    <h6>Microsoft Authenticator</h6>
                                    <small class="text-muted">من مايكروسوفت</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backup Codes Modal -->
<div class="modal fade" id="backupCodesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">رموز الاسترداد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>مهم جداً:</strong> احفظ هذه الرموز في مكان آمن. يمكنك استخدامها للدخول إذا فقدت جهازك.
                </div>
                
                <div id="backupCodesList" class="row">
                    <!-- Backup codes will be inserted here -->
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="printBackupCodes()">
                        <i class="fas fa-print me-2"></i>
                        طباعة
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="downloadBackupCodes()">
                        <i class="fas fa-download me-2"></i>
                        تحميل
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                    <i class="fas fa-home me-2"></i>
                    الذهاب للوحة التحكم
                </a>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Auto-format token input
    $('#token').on('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 6) {
            value = value.substring(0, 6);
        }
        this.value = value;
    });
    
    // Handle form submission
    $('#setup2faForm').on('submit', function(e) {
        e.preventDefault();
        
        const token = $('#token').val();
        if (token.length !== 6) {
            showAlert('error', 'خطأ', 'يرجى إدخال رمز مكون من 6 أرقام');
            return;
        }
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>جاري التحقق...').prop('disabled', true);
        
        $.ajax({
            url: '{{ url_for("two_factor.verify_setup") }}',
            method: 'POST',
            data: {
                token: token
            },
            success: function(response) {
                if (response.success) {
                    showAlert('success', 'نجح!', response.message);
                    
                    // Show backup codes
                    if (response.backup_codes) {
                        showBackupCodes(response.backup_codes);
                    }
                } else {
                    showAlert('error', 'خطأ', response.error);
                }
            },
            error: function() {
                showAlert('error', 'خطأ', 'حدث خطأ في الاتصال');
            },
            complete: function() {
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
});

function showBackupCodes(codes) {
    const codesList = $('#backupCodesList');
    codesList.empty();
    
    codes.forEach(function(code, index) {
        codesList.append(`
            <div class="col-md-6 mb-2">
                <div class="bg-light p-2 rounded text-center">
                    <code style="font-size: 1.1rem;">${code}</code>
                </div>
            </div>
        `);
    });
    
    // Store codes for download/print
    window.backupCodes = codes;
    
    const modal = new bootstrap.Modal(document.getElementById('backupCodesModal'));
    modal.show();
}

function printBackupCodes() {
    if (!window.backupCodes) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>رموز الاسترداد - المصادقة الثنائية</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .codes { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                .code { background: #f8f9fa; padding: 10px; text-align: center; border: 1px solid #dee2e6; }
                .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin-bottom: 20px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>رموز الاسترداد - المصادقة الثنائية</h2>
                <p>نظام إدارة مطالبات التأمين</p>
                <p>المستخدم: {{ current_user.full_name }} ({{ current_user.email }})</p>
                <p>التاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
            </div>
            
            <div class="warning">
                <strong>تحذير:</strong> احفظ هذه الرموز في مكان آمن. كل رمز يمكن استخدامه مرة واحدة فقط.
            </div>
            
            <div class="codes">
                ${window.backupCodes.map(code => `<div class="code">${code}</div>`).join('')}
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function downloadBackupCodes() {
    if (!window.backupCodes) return;
    
    const content = `رموز الاسترداد - المصادقة الثنائية
نظام إدارة مطالبات التأمين
المستخدم: {{ current_user.full_name }} ({{ current_user.email }})
التاريخ: ${new Date().toLocaleDateString('ar-SA')}

تحذير: احفظ هذه الرموز في مكان آمن. كل رمز يمكن استخدامه مرة واحدة فقط.

${window.backupCodes.join('\n')}`;
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'backup-codes-2fa.txt';
    link.click();
}

function showAlert(type, title, message) {
    Swal.fire({
        icon: type,
        title: title,
        text: message,
        confirmButtonText: 'موافق'
    });
}
</script>
{% endblock %}
